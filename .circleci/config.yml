version: 2

references:
    setup_remote_docker: &setup_remote_docker
      setup_remote_docker:
        version: 17.11.0-ce

jobs:
  build:

    docker:
      - image: circleci/python:3.6.1
      - image: bluszcz/bflocalstack-dynamodb-s3
      - image: alismedia/dynamodb-local
        environment:
          MAX_HEAP_SIZE: 2048m
          HEAP_NEWSIZE: 512m
      - image: docker.elastic.co/elasticsearch/elasticsearch:6.2.0
        environment:
          discovery.type: single-node

    working_directory: ~/repo

    steps:
      - checkout
      - <<: *setup_remote_docker
      # Download and cache dependencies
      - restore_cache:
          keys:
          - v3-dependencies-{{ checksum "requirements.txt" }}
          - v3-dependencies-{{ checksum "requirements_web3.txt" }}
          - v3-dependencies-

      - run:
          name: install dependencies
          command: |
            python3 -m venv venv
            . venv/bin/activate
            pip install -r requirements.txt
            pip install -r requirements_test.txt

      - save_cache:
          paths:
            - ./venv
          key: v3-dependencies-{{ checksum "requirements.txt" }}

      - run:
          name: run checkstyle for python code
          command: |
            . venv/bin/activate
            pycodestyle src tests ./*.py

      - run:
          name: run pyflakes for python code
          command: |
            . venv/bin/activate
            pyflakes src tests ./*.py

      - run:
          name: run tests
          command: |
            . venv/bin/activate
            # 全テスト実行
            python exec_test.py

      - run:
          name: deactivate venv
          command: |
            # venvをdeactiveにする
            deactivate

      - run:
          name: install dependencies including web3
          command: |
            python3 -m venv venv_web3
            . venv_web3/bin/activate
            pip install -r requirements_web3.txt
            pip install -r requirements_test.txt

      - save_cache:
          paths:
          - ./venv_web3
          key: v3-dependencies-{{ checksum "requirements_web3.txt" }}

      - run:
          name: run tests including web3
          command: |
            . venv_web3/bin/activate
            # web3を含んだ全テスト実行
            python exec_test_include_web3.py

      - run:
          name: deactivate venv_web3
          command: |
            # venv_web3をdeactiveにする
            deactivate

      - run:
          name: make deploy package
          command: |
            if [ $ALIS_APP_ID ]; then
              docker image build --tag deploy-image .
              docker container run -it --name deploy-container deploy-image
              docker container cp deploy-container:/workdir/vendor-package .
              docker container cp deploy-container:/workdir/vendor-package-web3 .
              . venv/bin/activate
              python make_deploy_zip.py
              python make_deploy_web3_zip.py
            fi

      - run:
          name: run deploy
          command: |
            if [ $ALIS_APP_ID ]; then
              . venv/bin/activate
              ./deploy_api.sh
            fi

      - store_artifacts:
          path: test-reports
          destination: test-reports
